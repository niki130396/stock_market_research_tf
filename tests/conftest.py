import pytest
from sqlalchemy import create_engine

from src.models.fundamentals import Base


@pytest.fixture
def connection_engine():
    return create_engine("sqlite:///:memory:")


@pytest.fixture
def setup_teardown_tables(connection_engine):
    Base.metadata.create_all(connection_engine)

    yield

    Base.metadata.drop_all(connection_engine)


class MockResponse:
    def __init__(self, json):
        self._json = json

    async def json(self):
        return self._json

    async def __aexit__(self, exc_type, exc, tb):
        pass

    async def __aenter__(self):
        return self


@pytest.fixture
def patch_client_response_get_company_information(monkeypatch):
    def patch(*args, **kwargs):
        mocker = MockResponse([
            {
                "symbol": "AAPL",
                "price": 178.72,
                "beta": 1.286802,
                "volAvg": 58405568,
                "mktCap": 2794144143933,
                "lastDiv": 0.96,
                "range": "124.17-198.23",
                "changes": -0.13,
                "companyName": "Apple Inc.",
                "currency": "USD",
                "cik": "0000320193",
                "isin": "US0378331005",
                "cusip": "037833100",
                "exchange": "NASDAQ Global Select",
                "exchangeShortName": "NASDAQ",
                "industry": "Consumer Electronics",
                "website": "https://www.apple.com",
                "description": "Apple Inc. designs, manufactures, and markets smartphones, personal computers, tablets, ",
                "ceo": "Mr. Timothy D. Cook",
                "sector": "Technology",
                "country": "US",
                "fullTimeEmployees": "164000",
                "phone": "408 996 1010",
                "address": "One Apple Park Way",
                "city": "Cupertino",
                "state": "CA",
                "zip": "95014",
                "dcfDiff": 4.15176,
                "dcf": 150.082,
                "image": "https://financialmodelingprep.com/image-stock/AAPL.png",
                "ipoDate": "1980-12-12",
                "defaultImage": False,
                "isEtf": False,
                "isActivelyTrading": False,
                "isAdr": False,
                "isFund": False
            }
        ])
        return mocker

    monkeypatch.setattr("src.utils.requests.aiohttp.ClientSession.get", patch)


@pytest.fixture
def patch_client_response_get_company_information_free_plan(monkeypatch):
    def patch(*args, **kwargs):
        mocker = MockResponse({
            "Error Message": "Free plan is limited to US stocks only please visit our subscription page to upgrade your plan at https://site.financialmodelingprep.com/developer/docs/pricing"
        })
        return mocker

    monkeypatch.setattr("src.utils.requests.aiohttp.ClientSession.get", patch)


@pytest.fixture
def patch_client_response_get_company_information_limit_reach(monkeypatch):
    def patch(*args, **kwargs):
        mocker = MockResponse({
            "Error Message": "Limit Reach ."
        })
        return mocker

    monkeypatch.setattr("src.utils.requests.aiohttp.ClientSession.get", patch)


@pytest.fixture
def patch_client_response_get_income_statements(monkeypatch):
    def patch(*args, **kwargs):
        mocker = MockResponse([
            {
                'date': '2023-12-31',
                'symbol': 'PWR',
                'reportedCurrency': 'USD',
                'cik': '0001050915',
                'fillingDate': '2024-02-22',
                'acceptedDate': '2024-02-22 09:56:10',
                'calendarYear': '2023',
                'period': 'FY',
                'revenue': 20882206000,
                'costOfRevenue': 18234134000,
                'grossProfit': 2648072000,
                'grossProfitRatio': 0.126809974,
                'researchAndDevelopmentExpenses': 0,
                'generalAndAdministrativeExpenses': 0,
                'sellingAndMarketingExpenses': 0,
                'sellingGeneralAndAdministrativeExpenses': 1513796000,
                'otherExpenses': 18063000,
                'operatingExpenses': 1513796000,
                'costAndExpenses': 19747930000,
                'interestIncome': 10830000,
                'interestExpense': 186913000,
                'depreciationAndAmortization': 613800000,
                'ebitda': 1748076000,
                'ebitdaratio': 0.0837112707,
                'operatingIncome': 1134276000,
                'operatingIncomeRatio': 0.0543178245,
                'totalOtherIncomeExpensesNet': -164320000,
                'incomeBeforeTax': 969956000,
                'incomeBeforeTaxRatio': 0.046448924,
                'incomeTaxExpense': 219267000,
                'netIncome': 744689000,
                'netIncomeRatio': 0.0356614143,
                'eps': 5.13,
                'epsdiluted': 5,
                'weightedAverageShsOut': 145222000,
                'weightedAverageShsOutDil': 148823000,
                'link': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091524000009/0001050915-24-000009-index.htm',
                'finalLink': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091524000009/pwr-20231231.htm'
            },
            {
                'date': '2022-12-31',
                'symbol': 'PWR',
                'reportedCurrency': 'USD',
                'cik': '0001050915',
                'fillingDate': '2023-02-23',
                'acceptedDate': '2023-02-23 10:03:37',
                'calendarYear': '2022',
                'period': 'FY',
                'revenue': 17073903000,
                'costOfRevenue': 14544748000,
                'grossProfit': 2529155000,
                'grossProfitRatio': 0.1481298681,
                'researchAndDevelopmentExpenses': 0,
                'generalAndAdministrativeExpenses': 0,
                'sellingAndMarketingExpenses': 0,
                'sellingGeneralAndAdministrativeExpenses': 1336711000,
                'otherExpenses': 353973000,
                'operatingExpenses': 1690684000,
                'costAndExpenses': 16235432000,
                'interestIncome': 2606000,
                'interestExpense': 124363000,
                'depreciationAndAmortization': 329043000,
                'ebitda': 1201101000,
                'ebitdaratio': 0.0703471842,
                'operatingIncome': 872058000,
                'operatingIncomeRatio': 0.0510754922,
                'totalOtherIncomeExpensesNet': -168172000,
                'incomeBeforeTax': 703886000,
                'incomeBeforeTaxRatio': 0.0412258404,
                'incomeTaxExpense': 192243000,
                'netIncome': 491189000,
                'netIncomeRatio': 0.0287684076,
                'eps': 3.42,
                'epsdiluted': 3.32,
                'weightedAverageShsOut': 143488000,
                'weightedAverageShsOutDil': 147992000,
                'link': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091523000010/0001050915-23-000010-index.htm',
                'finalLink': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091523000010/pwr-20221231.htm'
            },
            {
                'date': '2021-12-31',
                'symbol': 'PWR',
                'reportedCurrency': 'USD',
                'cik': '0001050915',
                'fillingDate': '2022-02-25',
                'acceptedDate': '2022-02-25 17:10:27',
                'calendarYear': '2021',
                'period': 'FY',
                'revenue': 12980213000,
                'costOfRevenue': 11026954000,
                'grossProfit': 1953259000,
                'grossProfitRatio': 0.150479734,
                'researchAndDevelopmentExpenses': 0,
                'generalAndAdministrativeExpenses': 0,
                'sellingAndMarketingExpenses': 0,
                'sellingGeneralAndAdministrativeExpenses': 1155956000,
                'otherExpenses': 165366000,
                'operatingExpenses': 1321322000,
                'costAndExpenses': 12348276000,
                'interestIncome': 3194000,
                'interestExpense': 68899000,
                'depreciationAndAmortization': 206122000,
                'ebitda': 869643000,
                'ebitdaratio': 0.0669975909,
                'operatingIncome': 663521000,
                'operatingIncomeRatio': 0.0511178823,
                'totalOtherIncomeExpensesNet': -40620000,
                'incomeBeforeTax': 622901000,
                'incomeBeforeTaxRatio': 0.0479885037,
                'incomeTaxExpense': 130918000,
                'netIncome': 485956000,
                'netIncomeRatio': 0.0374382146,
                'eps': 3.45,
                'epsdiluted': 3.34,
                'weightedAverageShsOut': 140824000,
                'weightedAverageShsOutDil': 145373000,
                'link': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091522000008/0001050915-22-000008-index.htm',
                'finalLink': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091522000008/pwr-20211231.htm'
            },
            {
                'date': '2020-12-31',
                'symbol': 'PWR',
                'reportedCurrency': 'USD',
                'cik': '0001050915',
                'fillingDate': '2021-03-01',
                'acceptedDate': '2021-02-26 18:54:46',
                'calendarYear': '2020',
                'period': 'FY',
                'revenue': 11202672000,
                'costOfRevenue': 9541825000,
                'grossProfit': 1660847000,
                'grossProfitRatio': 0.1482545414,
                'researchAndDevelopmentExpenses': 0,
                'generalAndAdministrativeExpenses': 0,
                'sellingAndMarketingExpenses': 0,
                'sellingGeneralAndAdministrativeExpenses': 975074000,
                'otherExpenses': 76704000,
                'operatingExpenses': 1051778000,
                'costAndExpenses': 10593603000,
                'interestIncome': 2449000,
                'interestExpense': 45013000,
                'depreciationAndAmortization': 90693000,
                'ebitda': 702064000,
                'ebitdaratio': 0.0626693346,
                'operatingIncome': 611371000,
                'operatingIncomeRatio': 0.0545736767,
                'totalOtherIncomeExpensesNet': -40025000,
                'incomeBeforeTax': 571346000,
                'incomeBeforeTaxRatio': 0.0510008684,
                'incomeTaxExpense': 119387000,
                'netIncome': 445596000,
                'netIncomeRatio': 0.0397758678,
                'eps': 3.15,
                'epsdiluted': 3.07,
                'weightedAverageShsOut': 141380000,
                'weightedAverageShsOutDil': 145247000,
                'link': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091521000009/0001050915-21-000009-index.htm',
                'finalLink': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091521000009/pwr-20201231.htm'
            },
            {
                'date': '2019-12-31',
                'symbol': 'PWR',
                'reportedCurrency': 'USD',
                'cik': '0001050915',
                'fillingDate': '2020-02-28',
                'acceptedDate': '2020-02-28 17:10:05',
                'calendarYear': '2019',
                'period': 'FY',
                'revenue': 12112153000,
                'costOfRevenue': 10511901000,
                'grossProfit': 1600252000,
                'grossProfitRatio': 0.1321195332,
                'researchAndDevelopmentExpenses': 0,
                'generalAndAdministrativeExpenses': 0,
                'sellingAndMarketingExpenses': 0,
                'sellingGeneralAndAdministrativeExpenses': 955991000,
                'otherExpenses': 62091000,
                'operatingExpenses': 1018082000,
                'costAndExpenses': 11529983000,
                'interestIncome': 927000,
                'interestExpense': 66890000,
                'depreciationAndAmortization': 173690000,
                'ebitda': 728564000,
                'ebitdaratio': 0.0601514859,
                'operatingIncome': 554874000,
                'operatingIncomeRatio': 0.0458113434,
                'totalOtherIncomeExpensesNet': 17413000,
                'incomeBeforeTax': 572287000,
                'incomeBeforeTaxRatio': 0.0472489903,
                'incomeTaxExpense': 165472000,
                'netIncome': 402044000,
                'netIncomeRatio': 0.033193438,
                'eps': 2.76,
                'epsdiluted': 2.73,
                'weightedAverageShsOut': 145710000,
                'weightedAverageShsOutDil': 147534000,
                'link': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091520000020/0001050915-20-000020-index.htm',
                'finalLink': 'https://www.sec.gov/Archives/edgar/data/1050915/000105091520000020/pwr-123119x10k.htm'
            }
        ])
        return mocker

    monkeypatch.setattr("src.utils.requests.aiohttp.ClientSession.get", patch)


@pytest.fixture
def patch_client_response_get_balance_sheet_statements(monkeypatch):
    def patch(*args, **kwargs):
        mocker = MockResponse([
            {
                "date": "2023-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2024-02-22",
                "acceptedDate": "2024-02-22 09:56:10",
                "calendarYear": "2023",
                "period": "FY",
                "cashAndCashEquivalents": 1293900000,
                "shortTermInvestments": 0,
                "cashAndShortTermInvestments": 1293900000,
                "netReceivables": 5824186000,
                "inventory": 175658000,
                "otherCurrentAssets": 383153000,
                "totalCurrentAssets": 7676897000,
                "propertyPlantEquipmentNet": 2586386000,
                "goodwill": 4045905000,
                "intangibleAssets": 1362412000,
                "goodwillAndIntangibleAssets": 5408317000,
                "longTermInvestments": 320038000,
                "taxAssets": 254004000,
                "otherNonCurrentAssets": -8417000,
                "totalNonCurrentAssets": 8560328000,
                "otherAssets": 0,
                "totalAssets": 16237225000,
                "accountPayables": 2027588000,
                "shortTermDebt": 613197000,
                "taxPayables": 0,
                "deferredRevenue": 1538677000,
                "otherCurrentLiabilities": 1033654000,
                "totalCurrentLiabilities": 5213116000,
                "longTermDebt": 3631694000,
                "deferredRevenueNonCurrent": 218806000,
                "deferredTaxLiabilitiesNonCurrent": 254004000,
                "otherNonCurrentLiabilities": 636250000,
                "totalNonCurrentLiabilities": 4740754000,
                "otherLiabilities": 0,
                "capitalLeaseObligations": 218806000,
                "totalLiabilities": 9953870000,
                "preferredStock": 0,
                "commonStock": 2000,
                "retainedEarnings": 4858066000,
                "accumulatedOtherComprehensiveIncomeLoss": -282945000,
                "othertotalStockholdersEquity": 1697118000,
                "totalStockholdersEquity": 6272241000,
                "totalEquity": 6283355000,
                "totalLiabilitiesAndStockholdersEquity": 16237225000,
                "minorityInterest": 11114000,
                "totalLiabilitiesAndTotalEquity": 16237225000,
                "totalInvestments": 320038000,
                "totalDebt": 4463697000,
                "netDebt": 3169797000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091524000009/0001050915-24-000009-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091524000009/pwr-20231231.htm",
            },
            {
                "date": "2022-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2023-02-23",
                "acceptedDate": "2023-02-23 10:03:37",
                "calendarYear": "2022",
                "period": "FY",
                "cashAndCashEquivalents": 428505000,
                "shortTermInvestments": 0,
                "cashAndShortTermInvestments": 428505000,
                "netReceivables": 4754731000,
                "inventory": 103265000,
                "otherCurrentAssets": 249569000,
                "totalCurrentAssets": 5536070000,
                "propertyPlantEquipmentNet": 2260155000,
                "goodwill": 3586745000,
                "intangibleAssets": 1458631000,
                "goodwillAndIntangibleAssets": 5045376000,
                "longTermInvestments": 501368000,
                "taxAssets": 227861000,
                "otherNonCurrentAssets": -106493000,
                "totalNonCurrentAssets": 7928267000,
                "otherAssets": 0,
                "totalAssets": 13464337000,
                "accountPayables": 1302086000,
                "shortTermDebt": 111547000,
                "taxPayables": 0,
                "deferredRevenue": 1141518000,
                "otherCurrentLiabilities": 851043000,
                "totalCurrentLiabilities": 3406194000,
                "longTermDebt": 3863944000,
                "deferredRevenueNonCurrent": 0,
                "deferredTaxLiabilitiesNonCurrent": 227861000,
                "otherNonCurrentLiabilities": 567519000,
                "totalNonCurrentLiabilities": 4659324000,
                "otherLiabilities": 0,
                "capitalLeaseObligations": 245564000,
                "totalLiabilities": 8065518000,
                "preferredStock": 0,
                "commonStock": 2000,
                "retainedEarnings": 4163212000,
                "accumulatedOtherComprehensiveIncomeLoss": -310677000,
                "othertotalStockholdersEquity": 1530927000,
                "totalStockholdersEquity": 5383464000,
                "totalEquity": 5398819000,
                "totalLiabilitiesAndStockholdersEquity": 13464337000,
                "minorityInterest": 15355000,
                "totalLiabilitiesAndTotalEquity": 13464337000,
                "totalInvestments": 501368000,
                "totalDebt": 3975491000,
                "netDebt": 3546986000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091523000010/0001050915-23-000010-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091523000010/pwr-20221231.htm",
            },
            {
                "date": "2021-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2022-02-25",
                "acceptedDate": "2022-02-25 17:10:27",
                "calendarYear": "2021",
                "period": "FY",
                "cashAndCashEquivalents": 229097000,
                "shortTermInvestments": 0,
                "cashAndShortTermInvestments": 229097000,
                "netReceivables": 4203771000,
                "inventory": 84659000,
                "otherCurrentAssets": 215050000,
                "totalCurrentAssets": 4732577000,
                "propertyPlantEquipmentNet": 2160302000,
                "goodwill": 3528886000,
                "intangibleAssets": 1801180000,
                "goodwillAndIntangibleAssets": 5330066000,
                "longTermInvestments": -191098000,
                "taxAssets": 191098000,
                "otherNonCurrentAssets": 632244000,
                "totalNonCurrentAssets": 8122612000,
                "otherAssets": 0,
                "totalAssets": 12855189000,
                "accountPayables": 1251118000,
                "shortTermDebt": 107417000,
                "taxPayables": 0,
                "deferredRevenue": 802872000,
                "otherCurrentLiabilities": 1003553000,
                "totalCurrentLiabilities": 3164960000,
                "longTermDebt": 3894901000,
                "deferredRevenueNonCurrent": 0,
                "deferredTaxLiabilitiesNonCurrent": 191098000,
                "otherNonCurrentLiabilities": 487309000,
                "totalNonCurrentLiabilities": 4573308000,
                "otherLiabilities": 0,
                "capitalLeaseObligations": 248678000,
                "totalLiabilities": 7738268000,
                "preferredStock": 0,
                "commonStock": 2000,
                "retainedEarnings": 3714843000,
                "accumulatedOtherComprehensiveIncomeLoss": -237689000,
                "othertotalStockholdersEquity": 1635145000,
                "totalStockholdersEquity": 5112301000,
                "totalEquity": 5116921000,
                "totalLiabilitiesAndStockholdersEquity": 12855189000,
                "minorityInterest": 4620000,
                "totalLiabilitiesAndTotalEquity": 12855189000,
                "totalInvestments": -191098000,
                "totalDebt": 4002318000,
                "netDebt": 3773221000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091522000008/0001050915-22-000008-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091522000008/pwr-20211231.htm",
            },
            {
                "date": "2020-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2021-03-01",
                "acceptedDate": "2021-02-26 18:54:46",
                "calendarYear": "2020",
                "period": "FY",
                "cashAndCashEquivalents": 184620000,
                "shortTermInvestments": 0,
                "cashAndShortTermInvestments": 184620000,
                "netReceivables": 3169915000,
                "inventory": 50472000,
                "otherCurrentAssets": 183382000,
                "totalCurrentAssets": 3588389000,
                "propertyPlantEquipmentNet": 1817501000,
                "goodwill": 2121014000,
                "intangibleAssets": 435655000,
                "goodwillAndIntangibleAssets": 2556669000,
                "longTermInvestments": -166407000,
                "taxAssets": 166407000,
                "otherNonCurrentAssets": 435713000,
                "totalNonCurrentAssets": 4809883000,
                "otherAssets": 0,
                "totalAssets": 8398272000,
                "accountPayables": 798023000,
                "shortTermDebt": 99898000,
                "taxPayables": 62902000,
                "deferredRevenue": 528864000,
                "otherCurrentLiabilities": 711771000,
                "totalCurrentLiabilities": 2138556000,
                "longTermDebt": 1353116000,
                "deferredRevenueNonCurrent": 0,
                "deferredTaxLiabilitiesNonCurrent": 166407000,
                "otherNonCurrentLiabilities": 391221000,
                "totalNonCurrentLiabilities": 1910744000,
                "otherLiabilities": 0,
                "capitalLeaseObligations": 263956000,
                "totalLiabilities": 4049300000,
                "preferredStock": 0,
                "commonStock": 2000,
                "retainedEarnings": 3264967000,
                "accumulatedOtherComprehensiveIncomeLoss": -232997000,
                "othertotalStockholdersEquity": 1312209000,
                "totalStockholdersEquity": 4344181000,
                "totalEquity": 4348972000,
                "totalLiabilitiesAndStockholdersEquity": 8398272000,
                "minorityInterest": 4791000,
                "totalLiabilitiesAndTotalEquity": 8398272000,
                "totalInvestments": -166407000,
                "totalDebt": 1453014000,
                "netDebt": 1268394000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091521000009/0001050915-21-000009-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091521000009/pwr-20201231.htm",
            },
            {
                "date": "2019-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2020-02-28",
                "acceptedDate": "2020-02-28 17:10:05",
                "calendarYear": "2019",
                "period": "FY",
                "cashAndCashEquivalents": 164798000,
                "shortTermInvestments": 0,
                "cashAndShortTermInvestments": 164798000,
                "netReceivables": 3349179000,
                "inventory": 55719000,
                "otherCurrentAssets": 261290000,
                "totalCurrentAssets": 3830986000,
                "propertyPlantEquipmentNet": 1671023000,
                "goodwill": 2022675000,
                "intangibleAssets": 413734000,
                "goodwillAndIntangibleAssets": 2436409000,
                "longTermInvestments": -214779000,
                "taxAssets": 214779000,
                "otherNonCurrentAssets": 393264000,
                "totalNonCurrentAssets": 4500696000,
                "otherAssets": 0,
                "totalAssets": 8331682000,
                "accountPayables": 1489559000,
                "shortTermDebt": 167344000,
                "taxPayables": 87074000,
                "deferredRevenue": 606146000,
                "otherCurrentLiabilities": 0,
                "totalCurrentLiabilities": 2263049000,
                "longTermDebt": 1488716000,
                "deferredRevenueNonCurrent": 0,
                "deferredTaxLiabilitiesNonCurrent": 214779000,
                "otherNonCurrentLiabilities": 311307000,
                "totalNonCurrentLiabilities": 2014802000,
                "otherLiabilities": 0,
                "capitalLeaseObligations": 288996000,
                "totalLiabilities": 4277851000,
                "preferredStock": 0,
                "commonStock": 2000,
                "retainedEarnings": 2854271000,
                "accumulatedOtherComprehensiveIncomeLoss": -241818000,
                "othertotalStockholdersEquity": 1437837000,
                "totalStockholdersEquity": 4050292000,
                "totalEquity": 4053831000,
                "totalLiabilitiesAndStockholdersEquity": 8331682000,
                "minorityInterest": 3539000,
                "totalLiabilitiesAndTotalEquity": 8331682000,
                "totalInvestments": -214779000,
                "totalDebt": 1656060000,
                "netDebt": 1491262000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091520000020/0001050915-20-000020-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091520000020/pwr-123119x10k.htm",
            }
        ])
        return mocker

    monkeypatch.setattr("src.utils.requests.aiohttp.ClientSession.get", patch)


@pytest.fixture
def patch_client_response_get_cash_flow_statements(monkeypatch):
    def patch(*args, **kwargs):
        mocker = MockResponse([
            {
                "date": "2023-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2024-02-22",
                "acceptedDate": "2024-02-22 09:56:10",
                "calendarYear": "2023",
                "period": "FY",
                "netIncome": 744689000,
                "depreciationAndAmortization": 613800000,
                "deferredIncomeTax": 3816000,
                "stockBasedCompensation": 126762000,
                "changeInWorkingCapital": 62617000,
                "accountsReceivables": -918732000,
                "inventory": 0,
                "accountsPayables": 771854000,
                "otherWorkingCapital": 209495000,
                "otherNonCashItems": 24268000,
                "netCashProvidedByOperatingActivities": 1575952000,
                "investmentsInPropertyPlantAndEquipment": -434803000,
                "acquisitionsNet": -582276000,
                "purchasesOfInvestments": -7537000,
                "salesMaturitiesOfInvestments": 42277000,
                "otherInvestingActivites": -7311000,
                "netCashUsedForInvestingActivites": -989650000,
                "debtRepayment": -408664000,
                "commonStockIssued": 817328000,
                "commonStockRepurchased": -350000,
                "dividendsPaid": -47752000,
                "otherFinancingActivites": -92062000,
                "netCashUsedProvidedByFinancingActivities": 268500000,
                "effectOfForexChangesOnCash": 7025000,
                "netChangeInCash": 861636000,
                "cashAtEndOfPeriod": 1293900000,
                "cashAtBeginningOfPeriod": 432264000,
                "operatingCashFlow": 1575952000,
                "capitalExpenditure": -434803000,
                "freeCashFlow": 1141149000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091524000009/0001050915-24-000009-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091524000009/pwr-20231231.htm",
            },
            {
                "date": "2022-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2023-02-23",
                "acceptedDate": "2023-02-23 10:03:37",
                "calendarYear": "2022",
                "period": "FY",
                "netIncome": 511643000,
                "depreciationAndAmortization": 644620000,
                "deferredIncomeTax": 42053000,
                "stockBasedCompensation": 105600000,
                "changeInWorkingCapital": -229715000,
                "accountsReceivables": -349485000,
                "inventory": -19333000,
                "accountsPayables": 144219000,
                "otherWorkingCapital": -5116000,
                "otherNonCashItems": 56111000,
                "netCashProvidedByOperatingActivities": 1130312000,
                "investmentsInPropertyPlantAndEquipment": -428782000,
                "acquisitionsNet": -273171000,
                "purchasesOfInvestments": -78084000,
                "salesMaturitiesOfInvestments": 20639000,
                "otherInvestingActivites": 142207000,
                "netCashUsedForInvestingActivites": -617191000,
                "debtRepayment": -9348118000,
                "commonStockIssued": 0,
                "commonStockRepurchased": -127762000,
                "dividendsPaid": -41058000,
                "otherFinancingActivites": 9205867000,
                "netCashUsedProvidedByFinancingActivities": -311071000,
                "effectOfForexChangesOnCash": -723000,
                "netChangeInCash": 201327000,
                "cashAtEndOfPeriod": 433214000,
                "cashAtBeginningOfPeriod": 231887000,
                "operatingCashFlow": 1130312000,
                "capitalExpenditure": -428782000,
                "freeCashFlow": 701530000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091523000010/0001050915-23-000010-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091523000010/pwr-20221231.htm",
            },
            {
                "date": "2021-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2022-02-25",
                "acceptedDate": "2022-02-25 17:10:27",
                "calendarYear": "2021",
                "period": "FY",
                "netIncome": 491983000,
                "depreciationAndAmortization": 420895000,
                "deferredIncomeTax": 26071000,
                "stockBasedCompensation": 88259000,
                "changeInWorkingCapital": -457682000,
                "accountsReceivables": -248452000,
                "inventory": 1418000,
                "accountsPayables": 95829000,
                "otherWorkingCapital": -306477000,
                "otherNonCashItems": 12864000,
                "netCashProvidedByOperatingActivities": 582390000,
                "investmentsInPropertyPlantAndEquipment": -386719000,
                "acquisitionsNet": -2590724000,
                "purchasesOfInvestments": 386719000,
                "salesMaturitiesOfInvestments": 29109000,
                "otherInvestingActivites": -336998000,
                "netCashUsedForInvestingActivites": -2898613000,
                "debtRepayment": -4269113000,
                "commonStockIssued": 6814843000,
                "commonStockRepurchased": -66687000,
                "dividendsPaid": -34022000,
                "otherFinancingActivites": -84144000,
                "netCashUsedProvidedByFinancingActivities": 2360877000,
                "effectOfForexChangesOnCash": 425000,
                "netChangeInCash": 45079000,
                "cashAtEndOfPeriod": 231887000,
                "cashAtBeginningOfPeriod": 186808000,
                "operatingCashFlow": 582390000,
                "capitalExpenditure": -386719000,
                "freeCashFlow": 195671000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091522000008/0001050915-22-000008-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091522000008/pwr-20211231.htm",
            },
            {
                "date": "2020-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2021-03-01",
                "acceptedDate": "2021-02-26 18:54:46",
                "calendarYear": "2020",
                "period": "FY",
                "netIncome": 451959000,
                "depreciationAndAmortization": 301960000,
                "deferredIncomeTax": -60016000,
                "stockBasedCompensation": 91641000,
                "changeInWorkingCapital": 327369000,
                "accountsReceivables": 71058000,
                "inventory": 9860000,
                "accountsPayables": 115569000,
                "otherWorkingCapital": 130882000,
                "otherNonCashItems": 3064000,
                "netCashProvidedByOperatingActivities": 1115977000,
                "investmentsInPropertyPlantAndEquipment": -260574000,
                "acquisitionsNet": -274681000,
                "purchasesOfInvestments": -14856000,
                "salesMaturitiesOfInvestments": 13963000,
                "otherInvestingActivites": 36825000,
                "netCashUsedForInvestingActivites": -499323000,
                "debtRepayment": -4190615000,
                "commonStockIssued": 3968813000,
                "commonStockRepurchased": -247249000,
                "dividendsPaid": -28891000,
                "otherFinancingActivites": -103423000,
                "netCashUsedProvidedByFinancingActivities": -601365000,
                "effectOfForexChangesOnCash": 1774000,
                "netChangeInCash": 17063000,
                "cashAtEndOfPeriod": 186808000,
                "cashAtBeginningOfPeriod": 169745000,
                "operatingCashFlow": 1115977000,
                "capitalExpenditure": -260574000,
                "freeCashFlow": 855403000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091521000009/0001050915-21-000009-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091521000009/pwr-20201231.htm",
            },
            {
                "date": "2019-12-31",
                "symbol": "PWR",
                "reportedCurrency": "USD",
                "cik": "0001050915",
                "fillingDate": "2020-02-28",
                "acceptedDate": "2020-02-28 17:10:05",
                "calendarYear": "2019",
                "period": "FY",
                "netIncome": 406815000,
                "depreciationAndAmortization": 280198000,
                "deferredIncomeTax": -7919000,
                "stockBasedCompensation": 52013000,
                "changeInWorkingCapital": -156805000,
                "accountsReceivables": -214580000,
                "inventory": 52168000,
                "accountsPayables": 39419000,
                "otherWorkingCapital": -33812000,
                "otherNonCashItems": -47751000,
                "netCashProvidedByOperatingActivities": 526551000,
                "investmentsInPropertyPlantAndEquipment": -262270000,
                "acquisitionsNet": -388432000,
                "purchasesOfInvestments": -47056000,
                "salesMaturitiesOfInvestments": 46590000,
                "otherInvestingActivites": 33572000,
                "netCashUsedForInvestingActivites": -617596000,
                "debtRepayment": -5905272000,
                "commonStockIssued": 6147266000,
                "commonStockRepurchased": -20092000,
                "dividendsPaid": -23236000,
                "otherFinancingActivites": -20979000,
                "netCashUsedProvidedByFinancingActivities": 177687000,
                "effectOfForexChangesOnCash": -153000,
                "netChangeInCash": 86489000,
                "cashAtEndOfPeriod": 169745000,
                "cashAtBeginningOfPeriod": 83256000,
                "operatingCashFlow": 526551000,
                "capitalExpenditure": -262270000,
                "freeCashFlow": 264281000,
                "link": "https://www.sec.gov/Archives/edgar/data/1050915/000105091520000020/0001050915-20-000020-index.htm",
                "finalLink": "https://www.sec.gov/Archives/edgar/data/1050915/000105091520000020/pwr-123119x10k.htm",
            }
        ])
        return mocker

    monkeypatch.setattr("src.utils.requests.aiohttp.ClientSession.get", patch)
