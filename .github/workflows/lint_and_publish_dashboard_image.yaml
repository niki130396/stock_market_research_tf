name: Lint and publish dashboard image

on:
  pull_request:
    paths:
      - 'stock_market_research_dashboard/**'
      - 'docker/stock_market_research_dashboard/**'
      - 'requirements/stock_market_research_dashboard.txt'
    secrets:
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
      TERRAFORM_SERVICE_ACCOUNT:
        required: true
      STOCK_MARKET_RESEARCH_DB_USER_PASSWORD:
        required: true
      STOCK_MARKET_RESEARCH_DB_HOST:
        required: true
      STOCK_MARKET_RESEARCH_DB_USERNAME:
        required: true
      STOCK_MARKET_RESEARCH_USER_SA_KEY:
        required: true
      RANDOM_SECRET:
        required: true
  push:
    branches:
      - main
    paths:
      - 'stock_market_research_dashboard/**'
      - 'docker/stock_market_research_dashboard/**'
      - 'requirements/stock_market_research_dashboard.txt'
    secrets:
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
      TERRAFORM_SERVICE_ACCOUNT:
        required: true
      STOCK_MARKET_RESEARCH_DB_USER_PASSWORD:
        required: true
      STOCK_MARKET_RESEARCH_DB_HOST:
        required: true
      STOCK_MARKET_RESEARCH_DB_USERNAME:
        required: true
      STOCK_MARKET_RESEARCH_USER_SA_KEY:
        required: true
      RANDOM_SECRET:
        required: true

permissions:
  contents: 'read'
  id-token: 'write'
  pull-requests: write


jobs:
  lint-dockerfile:
    uses: ./.github/workflows/reusable_lint_dockerfile_workflow.yaml
    with:
      context: .
      file: docker/stock_market_research_dashboard/Dockerfile
      image_name: stock_market_research_dashboard
      environment: terraform-plan
    secrets:
      service_account: '${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}'
      workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'
      docker_env_vars: |
        STOCK_MARKET_RESEARCH_DB_HOST=${{ secrets.STOCK_MARKET_RESEARCH_DB_HOST }}
        STOCK_MARKET_RESEARCH_DB_USERNAME=${{ secrets.STOCK_MARKET_RESEARCH_DB_USERNAME }}
        STOCK_MARKET_RESEARCH_DB_USER_PASSWORD=${{ secrets.STOCK_MARKET_RESEARCH_DB_USER_PASSWORD }}
      docker_secrets: |
        "RANDOM_SECRET=${{ secrets.RANDOM_SECRET }}"

  publish-image:
    uses: ./.github/workflows/reusable_publish_docker_image_workflow.yaml
    needs: lint-dockerfile
    with:
      context: .
      file: docker/stock_market_research_dashboard/Dockerfile
      image_name: stock_market_research_dashboard
      environment: terraform-apply
    secrets:
      service_account: '${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}'
      workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'
      docker_secrets: |
        "STOCK_MARKET_RESEARCH_USER_SA_KEY=${{ secrets.STOCK_MARKET_RESEARCH_USER_SA_KEY }}"

  update-cloud-run-service:
    uses: ./.github/workflows/reusable_update_cloud_run_object.yaml
    needs: publish-image
    with:
      image_tag: ${{ needs.publish-image.outputs.image_tag }}
      object_project_id: stock-market-research-410417
      object_group_label: stock_market_research_dashboard
      object_type: service
      environment: terraform-apply
    secrets:
      service_account: '${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}'
      workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'
